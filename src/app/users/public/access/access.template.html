<div class="access-page">
  <h1 class="m_T-0">User Access</h1>

  <!-- Pending Requests -->
  <ng-container *ngIf="requests.length">
    <h2>Pending Requests</h2>
    <div class="requests-container">
      <div class="request-block" *ngFor="let req of requests; let i = index">
        <div class="usa-grid-full">
          <!-- Details Column -->
          <div class="usa-width-five-sixths">
            <div class="usa-grid-full">
              <div class="usa-width-one-fourth">
                <div><strong>Domain</strong></div>
                <div class="m_T-2x"><span>{{getDomainNameById(req.domainId)}}</span></div>
              </div>
              <div class="usa-width-one-fourth">
                <div><strong>Date Requested</strong></div>
                <div class="m_T-2x"><span>{{req.createdDate | dateFormat: 'MMM DD, YYYY'}}</span></div>
              </div>
              <div class="usa-width-one-half">
                <div><strong>Message</strong></div>
                <div class="m_T-2x"><span>{{trimRequest(req.requestorMessage)}}</span></div>
              </div>
            </div>
          </div>

          <!-- Cancel -->
          <div class="usa-width-one-sixth clearfix">
            <button class="usa-button-transparent pull-right" (click)="onCancelRequestClick(req.id, i)">
              <a class="no-underline"><i class="fa fa-close"></i>&nbsp;Cancel</a>
            </button>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <div class="m_T-4x">
    <samMultiSelectDropdown [hasSelectAll]="hasSelectAll(filters.domains.options)" (modelChange)="domainsChanged($event)" [options]="filters.domains.options" [label]="filters.domains.label" [name]="filters.domains.label" [model]="filters.domains.value"></samMultiSelectDropdown>
    <samMultiSelectDropdown [hasSelectAll]="hasSelectAll(filters.roles.options)" (modelChange)="rolesChanged($event)" [options]="filters.roles.options" [label]="filters.roles.label" [name]="filters.roles.label" [model]="filters.roles.value"></samMultiSelectDropdown>
    <samMultiSelectDropdown [hasSelectAll]="hasSelectAll(filters.organizations.options)" (modelChange)="orgsChanged($event)" [options]="filters.organizations.options" [label]="filters.organizations.label" [name]="filters.organizations.label" [model]="filters.organizations.value"></samMultiSelectDropdown>
    <samMultiSelectDropdown [hasSelectAll]="hasSelectAll(filters.objects.options)" (modelChange)="objectsChanged($event)" [options]="filters.objects.options" [label]="filters.objects.label" [name]="filters.objects.label" [model]="filters.objects.value"></samMultiSelectDropdown>
    <samMultiSelectDropdown [hasSelectAll]="hasSelectAll(filters.permissions.options)" (modelChange)="permissionsChanged($event)" [options]="filters.permissions.options" [label]="filters.permissions.label" [name]="filters.permissions.label" [model]="filters.permissions.value"></samMultiSelectDropdown>
    <a [routerLink]="[isAdmin ? '../grant-access' : '../request-access']" class="usa-button usa-button-success pull-right">{{isAdmin ? 'Grant' : 'Request'}} Access</a>
  </div>

  <samModal #deleteModal title="Confirm Removal" cancelButtonLabel="Cancel" submitButtonLabel="Remove" (onSubmit)="onDeleteConfirm()" [closeOnOutsideClick]="false" type="error">
    <p>Are you sure you wish to remove the following access?</p>
    <div>
      <div class="modal-subtitle">
        <strong class="modal-subtitle">Domain:</strong>
      </div>
      <div>{{modalDomain.val}}</div>
    </div>
    <div>
      <div class="modal-subtitle"><strong>Role:</strong></div>
      <div>{{modalRole.role.val}}</div>
    </div>
    <div>
      <div class="modal-subtitle">
        <strong>Organizations:</strong>
      </div>
      <div *ngFor="let org of modalRole.organizationMapContent[0].organizations">
        {{orgName(org)}}
      </div>
    </div>
  </samModal>

  <ng-container *ngIf="userAccessModel">
    <div *ngFor="let domain of userAccessModel.raw().domainMapContent">
      <h2>
        {{domain.domain.val || 'Domain not found'}}
        <a class="usa-button usa-button-transparent pull-right" *ngIf="firstRole && showCollapse" (click)="collapseAll()">Collapse All</a>
        <a class="usa-button usa-button-transparent pull-right" *ngIf="firstRole && !showCollapse" (click)="expandAll()">Expand All</a>
      </h2>
      <div class="background-grey role-block" *ngFor="let role of domain.roleMapContent">
        <div class="p_All-3x">
          <div class="usa-grid-full">
            <div class="usa-width-one-sixth">
              <strong>Role</strong>
            </div>
            <div class="usa-width-two-thirds">
              {{role.role.val || 'Role not found'}}
            </div>
            <div class="usa-width-one-sixth no-wrap modify-role-buttons" *ngIf="isAdmin">
              <div class="pull-right">
                <button class="usa-button-transparent m_T-0 underline" (click)="onEditClick(role, domain, role.organizationMapContent[0].organizations)"><i class="fa fa-edit"></i>&nbsp;Edit</button>
                <button (click)="onDeleteRoleClick(role, domain.domain)" class="usa-button-transparent m_T-0 m_R-0 underline"><i class="fa fa-trash"></i>&nbsp;Delete</button>
              </div>
            </div>
          </div>
          <div class="usa-grid-full organizations-row">
            <div class="usa-width-one-sixth">
              <strong>Organizations</strong>
            </div>
            <div class="usa-width-five-sixths">
              <div *ngFor="let orgId of role.organizationMapContent[0].organizations; let lastOrg=last;">
                {{orgName(orgId) || 'Org not Found'}}
                <button (click)="onShowPermissionsClick(role)" *ngIf="lastOrg" class="usa-button-transparent pull-right show-permissions-button m_0 underline"><i class="fa" [ngClass]="role.isOpen ? 'fa-minus' : 'fa-plus'"></i>&nbsp;{{role.isOpen ? "Hide" : "Show"}} Permissions</button>
              </div>
            </div>
          </div>
        </div>
        <div class="background-white permissions-block" *ngIf="role.isOpen">
          <div class="border-bottom-black permissions-table-header">
            <div class="usa-grid-full">
              <div class="usa-width-one-fourth">
                Object
              </div>
              <div class="usa-width-one-fourth">
                Permissions
              </div>
            </div>
          </div>
          <div class="usa-grid-full permissions-table-body" *ngFor="let obj of role.organizationMapContent[0].functionMapContent">
            <div class="usa-width-one-fourth">
              {{obj.function.val || 'object not found'}}
            </div>
            <div class="usa-width-three-fourths">
              <span *ngFor="let perm of obj.permission; let lastPermission=last">{{perm.val || 'Permission not Found'}}<span *ngIf="!lastPermission">, </span></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>
