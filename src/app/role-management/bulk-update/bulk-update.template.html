<div class="usa-grid m_T-4x bulk-update-page">
  <aside class="usa-width-one-fourth">
    <ul class="usa-sidenav-list">
      <li>
        <a [ngClass]="isCurrentTab('filters') && 'usa-current'">Filters</a>
        <a [ngClass]="isCurrentTab('users') && 'usa-current'">Users</a>
        <a [ngClass]="isCurrentTab('access') && 'usa-current'">Access</a>
        <a [ngClass]="isCurrentTab('confirmation') && 'usa-current'">Confirmation</a>
      </li>
    </ul>
  </aside>
  <div class="usa-width-three-fourths" [ngSwitch]="currentTab">
    <sam-title-subtitle titleText="Role Management" subtitle="Bulk Update"></sam-title-subtitle>

    <!-- Filters Tab -->
    <ng-container *ngSwitchCase="'filters'">

      <span>All fields are required.</span>
      <h3>Filters</h3>

      <div class="usa-grid-full">
        <div class="usa-width-one-half">
          <!-- Org -->
          <sam-agency-picker [label]="'Organization'"
                             [multimode]="false"
                             (organization)="onOrganizationChange($event)"
                             [required]="true"
                             [searchMessage]="errors.org"
                             [orgRoot]="user.departmentID"
          ></sam-agency-picker>

          <!-- Domain -->
          <sam-select
            name="domain"
            label="Domain"
            [model]="domain"
            (modelChange)="onDomainChange($event)"
            [options]="domainOptions"
            required="true"
            [errorMessage]="errors.domain">
          </sam-select>

          <!-- Role -->
          <sam-select
            name="role"
            label="Role"
            [model]="existingRole"
            (modelChange)="onExistingRoleChange($event)"
            [options]="roleOptions"
            required="true"
            [errorMessage]="errors.role">
          </sam-select>
        </div>
      </div>
    </ng-container>

    <!-- User Select Tab -->
    <ng-container *ngSwitchCase="'users'">
      <h3>Filters</h3>
      <div class="usa-grid-full">
        <div class="usa-width-one-sixth"><b>Organization</b></div>
        <div class="usa-width-five-sixths">{{org && org.name}}</div>
      </div>
      <div class="usa-grid-full">
        <div class="usa-width-one-sixth"><b>Domain</b></div>
        <div class="usa-width-five-sixths">{{domainName()}}</div>
      </div>
      <div class="usa-grid-full">
        <div class="usa-width-one-sixth"><b>Role</b></div>
        <div class="usa-width-five-sixths">{{getExistingRoleName()}}</div>
      </div>
      <h3>Users</h3>
      <p>Here is the list of users from your selected filters. When users are unchecked from this list, their access will not be included in this update.</p>
      <div class="clearfix">
        <div class="pull-right">
          <label for="sort-by" style="display: inline-block" class="m_T-0">Sort by</label>
          <select (change)="doUserSearch()" id="sort-by" [(ngModel)]="sort" style="display: inline-block; width: initial">
            <option
              *ngFor="let option of sortOptions"
              [value]="option.value"
            >{{option.label}}</option>
          </select>
        </div>
      </div>
      <div class="clearfix">
        <div class="pull-right">
          <a (click)="toggleSelectAll()">{{showDeselect ? 'Deselect All' : 'Select All'}}</a>
        </div>
      </div>
      <div class="m_T-4x" style="max-height: 300px; overflow-y: auto; border: 1px solid grey; padding: 1em">
        <div class="sam-ui two column wide grid" *ngIf="!areUsersLoading">
          <div class="column" *ngFor="let user of users">
            <input [attr.id]='user.email' type="checkbox" [(ngModel)]="user.isSelected">
            <label [attr.for]='user.email' style="margin-top: .2em">{{formatUserName(user)}}<i>{{user.email}}</i></label>
          </div>
        </div>
        <div class="text-center" *ngIf="areUsersLoading"><sam-spinner></sam-spinner></div>
      </div>
      <p class="m_T-4x">
        <sam-radio-button [(model)]="mode"
                          [name]="'mode'"
                          [errorMessage]="errors.mode"
                          [label]="'What change do you want to make to these users?'"
                          [options]="modeOptions"
        ></sam-radio-button>
      </p>

    </ng-container>

    <!-- Access Tab -->
    <ng-container *ngSwitchCase="'access'">
      <h3>Filters</h3>
      <div class="usa-grid-full">
        <div class="usa-width-one-sixth"><b>Organization</b></div>
        <div class="usa-width-five-sixths">{{org.name}}</div>
      </div>
      <div class="usa-grid-full">
        <div class="usa-width-one-sixth"><b>Domain</b></div>
        <div class="usa-width-five-sixths">{{domainName()}}</div>
      </div>
      <div class="usa-grid-full">
        <div class="usa-width-one-sixth"><b>Role</b></div>
        <div class="usa-width-five-sixths">{{getExistingRoleName()}}</div>
      </div>
      <h3>Users</h3>
      <div class="sam-ui two column wide grid">
        <div class="column" style="padding-bottom: 0; padding-top: 0" *ngFor="let user of getSelectedUsers()">
          {{formatUserName(user)}}<i>{{user.email}}</i>
        </div>
      </div>
      <h3 class="m_T-4x">Access</h3>
      <div class="usa-grid-full">
        <div class="usa-width-one-half">
          <!-- Role -->
          <sam-select
            name="role"
            label="Role"
            hint="Update the user's current permissions below, or change their role to give them new permissions."
            [model]="updatedRole"
            (modelChange)="onUpdatedRoleChange($event)"
            [options]="roleOptions"
            required="true"
            [errorMessage]="errors.role">
          </sam-select>
        </div>
      </div>
      <div>
        <h4 class="text-lighter m_T-4x">Permissions</h4>
        <div class="p_All-3x" style="background-color: #f1f1f1" *ngIf="objects && objects.length">
          <div *ngFor="let object of objects">
            <b class="m_B-0">{{object.function.val | capitalize}}</b>
            <div class="sam-ui two column wide grid">
              <div class="column" *ngFor="let permission of object.permission">
                <input [disabled]="permission.isDefault"
                       [attr.id]="permissionId(permission, object)"
                       type="checkbox" class="permission-input"
                       [ngModel]="!permission.notChecked"
                       (click)="onPermissionClick(permission)">
                <label [attr.for]="permissionId(permission, object)"
                       class="permission-label m_T-2x" >
                  {{permission.val | capitalize}}
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <h3>Comments</h3>

      <!-- Optional Message -->
      <sam-text-area
        name="comments"
        label="Edit these permissions has an effect on the users access at their organization. Provide a reason for the change."
        [(ngModel)]="comments"
      ></sam-text-area>

    </ng-container>

    <!-- Confirmation Tab -->
    <ng-container *ngSwitchCase="'confirmation'">
      <p>Confirm the information is correct</p>
      <h3>Filters</h3>
      <div class="usa-grid-full">
        <div class="usa-width-one-sixth"><b>Organization</b></div>
        <div class="usa-width-five-sixths">{{org.name}}</div>
      </div>
      <div class="usa-grid-full">
        <div class="usa-width-one-sixth"><b>Domain</b></div>
        <div class="usa-width-five-sixths">{{domainName()}}</div>
      </div>
      <div class="usa-grid-full">
        <div class="usa-width-one-sixth"><b>Role</b></div>
        <div class="usa-width-five-sixths">{{getExistingRoleName()}}</div>
      </div>
      <h3>Users</h3>
      <div class="sam-ui two column wide grid">
        <div class="column" style="padding-bottom: 0; padding-top: 0" *ngFor="let user of getSelectedUsers()">
          {{formatUserName(user)}} - <i>{{user.email}}</i>
        </div>
      </div>

      <ng-container *ngIf="mode === 'update'">
        <h3>Access</h3>
        <p>Below is a summary of the access you giving these users</p>
        <div class="usa-grid-full" *ngIf="isRoleUpdated()">
          <div class="usa-width-one-fourth"><h4>Updated Role</h4></div>
          <div class="usa-width-three-fourths">{{getUpdatedRoleName()}}</div>
        </div>
        <h4>Permissions</h4>
        <div style="border: 1px solid grey; padding: .5em">
          <div class="usa-grid-full" *ngFor="let obj of getSelectedObjects()">
            <div class="usa-width-one-fourth"><b>{{obj.function.val | capitalize}}</b></div>
            <div class="usa-width-three-fourths">{{getSelectedPermissions(obj)}}</div>
          </div>
        </div>
      </ng-container>

      <h3>Comments</h3>
      <!-- Show the comment left on the access tab if mode === 'update' -->
      <ng-container *ngIf="this.mode === 'update'">
        <ng-container *ngIf="comments">
          <p>You wrote:</p>
          <p>{{comments}}</p>
        </ng-container>
        <ng-container *ngIf="!comments">
          <i>Comment left empty</i>
        </ng-container>
      </ng-container>

      <!-- Allow user to leave a comment if mode === 'remove' -->
      <ng-container *ngIf="this.mode === 'remove'">
        <!-- Optional Message -->
        <sam-text-area
          name="comments"
          [required]="true"
          label="Removing users from a role significantly impacts their ability to perform their duties. Please be sure you want to remove them from this role, and provide a comment explaining why."
          [(ngModel)]="comments"
        ></sam-text-area>
      </ng-container>
    </ng-container>

    <div class="pull-right clearfix">
      <button class="usa-button-outline" *ngIf="!isCurrentTab('filters')" (click)="onBackClick()">Back</button>
      <button class="usa-button-primary" *ngIf="!isCurrentTab('confirmation')" (click)="onNextClick()" [disabled]="areUsersLoading">
        <span *ngIf="!shouldShowNextSpinner()">Next</span>
        <sam-spinner *ngIf="shouldShowNextSpinner()"></sam-spinner>
      </button>

      <button class="usa-button-primary m_R-0" *ngIf="isCurrentTab('confirmation')" (click)="onDoneClick()">Done</button>
    </div>

  </div>
</div>
